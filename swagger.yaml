openapi: 3.0.0

info:
  title: Wacdo API
  version: 1.0.0
  description: >
    API back-office Wacdo (produits, menus, commandes, utilisateurs).
    Authentification JWT et contrôle d'accès par rôles.

servers:
  - url: http://localhost:3000
    description: Serveur local

tags:
  - name: Products
    description: Gestion des produits
  - name: Menus
    description: Gestion des menus
  - name: Orders
    description: Gestion des commandes
  - name: Users
    description: Gestion des utilisateurs et authentification

paths:
  # -------------------------
  # PRODUCTS
  # -------------------------
  /api/products:
    get:
      summary: Récupérer la liste des produits
      tags: [Products]
      responses:
        "200":
          description: Liste des produits
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Product"

    post:
      summary: Créer un produit
      tags: [Products]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ProductCreate"
            examples:
              example:
                value:
                  name: "Burger Deluxe"
                  priceCents: 990
                  isAvailable: true
                  imageUrl: "https://example.com/burger.png"
      responses:
        "201":
          description: Produit créé
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Product"
        "400":
          description: Données invalides
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/products/{id}:
    get:
      summary: Récupérer un produit par ID
      tags: [Products]
      parameters:
        - $ref: "#/components/parameters/IdParam"
      responses:
        "200":
          description: Produit trouvé
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Product"
        "404":
          description: Produit non trouvé
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

    put:
      summary: Mettre à jour un produit
      tags: [Products]
      parameters:
        - $ref: "#/components/parameters/IdParam"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ProductUpdate"
            examples:
              example:
                value:
                  priceCents: 850
                  isAvailable: false
      responses:
        "200":
          description: Produit mis à jour
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Product"
        "400":
          description: Données invalides / ID invalide
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Produit non trouvé
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

    delete:
      summary: Supprimer un produit
      tags: [Products]
      parameters:
        - $ref: "#/components/parameters/IdParam"
      responses:
        "200":
          description: Produit supprimé
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Message"
              examples:
                example:
                  value:
                    message: "Produit supprimé avec succès"
        "404":
          description: Produit non trouvé
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  # -------------------------
  # MENUS
  # -------------------------
  /api/menus:
    get:
      summary: Récupérer la liste des menus
      tags: [Menus]
      responses:
        "200":
          description: Liste des menus
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Menu"

    post:
      summary: Créer un menu
      tags: [Menus]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MenuCreate"
            examples:
              example:
                value:
                  name: "Menu Big Wacdo"
                  description: "Burger + frites + boisson"
                  priceCents: 1290
                  isAvailable: true
      responses:
        "201":
          description: Menu créé
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Menu"
        "400":
          description: Données invalides
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/menus/{id}:
    get:
      summary: Récupérer un menu par ID
      tags: [Menus]
      parameters:
        - $ref: "#/components/parameters/IdParam"
      responses:
        "200":
          description: Menu trouvé
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Menu"
        "404":
          description: Menu non trouvé
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

    put:
      summary: Mettre à jour un menu
      tags: [Menus]
      parameters:
        - $ref: "#/components/parameters/IdParam"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MenuUpdate"
            examples:
              example:
                value:
                  priceCents: 1390
                  isAvailable: false
      responses:
        "200":
          description: Menu mis à jour
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Menu"
        "400":
          description: Données invalides / ID invalide
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Menu non trouvé
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

    delete:
      summary: Supprimer un menu
      tags: [Menus]
      parameters:
        - $ref: "#/components/parameters/IdParam"
      responses:
        "200":
          description: Menu supprimé
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Message"
              examples:
                example:
                  value:
                    message: "Menu supprimé avec succès"
        "404":
          description: Menu non trouvé
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  # -------------------------
  # ORDERS
  # -------------------------
  /api/orders:
    get:
      summary: Récupérer la liste des commandes
      tags: [Orders]
      responses:
        "200":
          description: Liste des commandes
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Order"

    post:
      summary: Créer une commande (ACCUEIL/ADMIN)
      tags: [Orders]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/OrderCreate"
            examples:
              example:
                value:
                  ticketId: "TICKET-1001"
                  items:
                    - productId: null
                      menuId: null
                      quantity: 2
                      unitPriceCents: 890
      responses:
        "201":
          description: Commande créée
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Order"
        "400":
          description: Données invalides
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "401":
          description: Token manquant/invalide
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Rôle insuffisant
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/orders/{id}:
    get:
      summary: Récupérer une commande par ID
      tags: [Orders]
      parameters:
        - $ref: "#/components/parameters/IdParam"
      responses:
        "200":
          description: Commande trouvée
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Order"
        "404":
          description: Commande non trouvée
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

    put:
      summary: Mettre à jour une commande (CRUD)
      tags: [Orders]
      parameters:
        - $ref: "#/components/parameters/IdParam"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/OrderUpdate"
            examples:
              example:
                value:
                  status: "CANCELLED"
      responses:
        "200":
          description: Commande mise à jour
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Order"
        "400":
          description: Données invalides / ID invalide
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Commande non trouvée
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

    delete:
      summary: Supprimer une commande
      tags: [Orders]
      parameters:
        - $ref: "#/components/parameters/IdParam"
      responses:
        "200":
          description: Commande supprimée
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Message"
              examples:
                example:
                  value:
                    message: "Commande supprimée avec succès"
        "404":
          description: Commande non trouvée
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/orders/{id}/prepared:
    patch:
      summary: Marquer une commande préparée (PREPARATION/ADMIN)
      tags: [Orders]
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/IdParam"
      responses:
        "200":
          description: Commande mise à jour (PREPARED)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Order"
        "401":
          description: Token manquant/invalide
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Rôle insuffisant
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Commande non trouvée
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/orders/{id}/delivered:
    patch:
      summary: Marquer une commande livrée (ACCUEIL/ADMIN)
      tags: [Orders]
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/IdParam"
      responses:
        "200":
          description: Commande mise à jour (DELIVERED)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Order"
        "401":
          description: Token manquant/invalide
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Rôle insuffisant
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Commande non trouvée
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  # -------------------------
  # USERS / AUTH
  # -------------------------
  /api/users/register:
    post:
      summary: Enregistrer un nouvel utilisateur
      tags: [Users]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UserRegister"
            examples:
              example:
                value:
                  username: "prep1"
                  password: "password123"
                  role: "PREPARATION"
      responses:
        "201":
          description: Utilisateur créé
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "400":
          description: Données invalides
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "409":
          description: Username déjà utilisé
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/users/login:
    post:
      summary: Connexion utilisateur (retourne un JWT)
      tags: [Users]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UserLogin"
            examples:
              example:
                value:
                  username: "admin1"
                  password: "password123"
      responses:
        "200":
          description: Connexion réussie
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LoginResponse"
        "400":
          description: Données manquantes
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "401":
          description: Identifiants invalides
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/users:
    get:
      summary: Récupérer tous les utilisateurs (ADMIN only)
      tags: [Users]
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Liste des utilisateurs (sans password)
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/User"
        "401":
          description: Token manquant/invalide
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Accès refusé (ADMIN requis)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    IdParam:
      name: id
      in: path
      required: true
      schema:
        type: string
      description: Identifiant MongoDB (ObjectId)

  schemas:
    Error:
      type: object
      properties:
        message:
          type: string
          example: "Une erreur est survenue"
        error:
          type: string
          example: "Détails optionnels"

    Message:
      type: object
      properties:
        message:
          type: string
          example: "OK"

    Product:
      type: object
      properties:
        _id:
          type: string
          example: "65fabc1234567890abcdef01"
        name:
          type: string
          example: "Burger Classic"
        priceCents:
          type: integer
          example: 890
        isAvailable:
          type: boolean
          example: true
        imageUrl:
          type: string
          example: "https://example.com/burger.png"
        createdAt:
          type: string
          format: date-time
          example: "2026-02-11T10:00:00.000Z"
        updatedAt:
          type: string
          format: date-time
          example: "2026-02-11T10:00:00.000Z"

    ProductCreate:
      type: object
      required: [name, priceCents]
      properties:
        name:
          type: string
        priceCents:
          type: integer
          minimum: 0
        isAvailable:
          type: boolean
        imageUrl:
          type: string

    ProductUpdate:
      type: object
      properties:
        name:
          type: string
        priceCents:
          type: integer
          minimum: 0
        isAvailable:
          type: boolean
        imageUrl:
          type: string

    Menu:
      type: object
      properties:
        _id:
          type: string
          example: "65fabc1234567890abcdef02"
        name:
          type: string
          example: "Menu Big Wacdo"
        description:
          type: string
          example: "Burger + frites + boisson"
        priceCents:
          type: integer
          example: 1290
        imageUrl:
          type: string
          example: "https://example.com/menu.png"
        isAvailable:
          type: boolean
          example: true
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    MenuCreate:
      type: object
      required: [name, priceCents]
      properties:
        name:
          type: string
        description:
          type: string
        priceCents:
          type: integer
          minimum: 0
        imageUrl:
          type: string
        isAvailable:
          type: boolean

    MenuUpdate:
      type: object
      properties:
        name:
          type: string
        description:
          type: string
        priceCents:
          type: integer
          minimum: 0
        imageUrl:
          type: string
        isAvailable:
          type: boolean

    Order:
      type: object
      properties:
        _id:
          type: string
          example: "65fabc1234567890abcdef03"
        ticketId:
          type: string
          example: "TICKET-1001"
        status:
          type: string
          enum: [CREATED, PREPARED, DELIVERED, CANCELLED]
          example: "CREATED"
        items:
          type: array
          items:
            $ref: "#/components/schemas/OrderItem"
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    OrderItem:
      type: object
      properties:
        productId:
          type: string
          nullable: true
          example: null
        menuId:
          type: string
          nullable: true
          example: null
        quantity:
          type: integer
          example: 2
          minimum: 1
        unitPriceCents:
          type: integer
          example: 890
          minimum: 0

    OrderCreate:
      type: object
      required: [ticketId, items]
      properties:
        ticketId:
          type: string
        items:
          type: array
          minItems: 1
          items:
            $ref: "#/components/schemas/OrderItem"

    OrderUpdate:
      type: object
      properties:
        status:
          type: string
          enum: [CREATED, PREPARED, DELIVERED, CANCELLED]
        items:
          type: array
          items:
            $ref: "#/components/schemas/OrderItem"

    User:
      type: object
      properties:
        _id:
          type: string
          example: "65fabc1234567890abcdef04"
        username:
          type: string
          example: "admin1"
        role:
          type: string
          enum: [ADMIN, PREPARATION, ACCUEIL]
          example: "ADMIN"
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    UserRegister:
      type: object
      required: [username, password]
      properties:
        username:
          type: string
          example: "prep1"
        password:
          type: string
          example: "password123"
        role:
          type: string
          enum: [ADMIN, PREPARATION, ACCUEIL]
          example: "PREPARATION"

    UserLogin:
      type: object
      required: [username, password]
      properties:
        username:
          type: string
          example: "admin1"
        password:
          type: string
          example: "password123"

    LoginResponse:
      type: object
      properties:
        token:
          type: string
          example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.xxx.yyy"
        user:
          type: object
          properties:
            id:
              type: string
              example: "65fabc1234567890abcdef04"
            username:
              type: string
              example: "admin1"
            role:
              type: string
              example: "ADMIN"